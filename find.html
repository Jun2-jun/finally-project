<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>내 주변 병원 찾기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background-color: #f7f9fb;
    }

    /* 상단 검색바 */
    .search-bar {
      position: sticky;
      top: 0;
      background-color: #ffffff;
      padding: 20px 15px;
      text-align: center;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .search-bar input[type="text"] {
      width: 300px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 16px;
      transition: 0.3s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #3498db;
    }

    .search-bar button {
      margin-left: 12px;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .search-bar button:hover {
      background-color: #2c80b4;
    }

    /* 지도와 결과 목록 */
    .map_wrap {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }

    #map {
      flex: 1;
      min-width: 300px;
      max-width: 800px;
      height: 600px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #menu_wrap {
      width: 300px;
      max-height: 600px;
      overflow-y: auto;
      background-color: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    #placesList li {
      list-style: none;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #placesList li:hover {
      background-color: #f2f8ff;
    }

    #placesList strong {
      font-size: 15px;
      color: #333;
    }

    #placesList span {
      font-size: 13px;
      color: #555;
    }

    #pagination {
      text-align: center;
      margin-top: 15px;
    }

    #pagination a {
      margin: 0 4px;
      text-decoration: none;
      color: #3498db;
      font-weight: bold;
    }

    #pagination .on {
      color: #2c3e50;
    }

    @media (max-width: 768px) {
      #menu_wrap {
        width: 100%;
        max-height: 300px;
        order: 2;
      }

      #map {
        width: 100%;
        height: 400px;
        order: 1;
      }

      .search-bar input[type="text"] {
        width: 70%;
      }

      .search-bar button {
        width: 25%;
        margin-left: 5px;
      }
    }
  </style>
</head>
<body>

<!-- 검색 바 -->
<div class="search-bar">
    <form onsubmit="searchPlaces(); return false;">
      동네 및 병원을 입력하세요
      <input type="text" id="keyword" value="병원" placeholder="예: 내과, 피부과, 치과...">
      <button type="submit">검색</button>
    </form>
  </div>
  
  <!-- 지도와 목록 -->
  <div class="map_wrap">
    <div id="map"></div>
    <div id="menu_wrap">
      <ul id="placesList"></ul>
      <div id="pagination"></div>
    </div>
  </div>
  
  <!-- 카카오 지도 API -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6be88c9794d7e1f9095b709637776b77&libraries=services"></script>
  <script>
    let map;
    let markers = [];
    let infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
  
    const mapContainer = document.getElementById('map');
  
    function initMap(lat, lng) {
      const mapOption = {
        center: new kakao.maps.LatLng(lat, lng),
        level: 5
      };
      map = new kakao.maps.Map(mapContainer, mapOption);
    }
  
    function searchPlaces() {
      const keyword = document.getElementById('keyword').value.trim();
      if (!keyword) {
        alert('검색어를 입력해주세요.');
        return;
      }
  
      const ps = new kakao.maps.services.Places();
      ps.keywordSearch(keyword, placesSearchCB, {
        location: map.getCenter()
      });
    }
  
    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        displayPlaces(data);
        displayPagination(pagination);
      } else {
        alert('검색 결과가 없습니다.');
      }
    }
  
    function displayPlaces(places) {
      const listEl = document.getElementById('placesList');
      listEl.innerHTML = '';
      removeMarkers();
  
      const bounds = new kakao.maps.LatLngBounds();
  
      places.forEach((place, index) => {
        const position = new kakao.maps.LatLng(place.y, place.x);
  
        const marker = new kakao.maps.Marker({
          position,
          map
        });
  
        kakao.maps.event.addListener(marker, 'click', () => {
          const content = `<div style="padding:5px;font-size:14px;">
            <a href="${place.place_url}" target="_blank" style="text-decoration:none;color:#3498db;">${place.place_name}</a>
          </div>`;
          infowindow.setContent(content);
          infowindow.open(map, marker);
        });
  
        markers.push(marker);
        bounds.extend(position);
  
        const itemEl = document.createElement('li');
  
        itemEl.innerHTML = `
          <strong>${place.place_name}</strong><br>
          <span>${place.road_address_name || place.address_name}</span><br>
          <span style="color:green">${place.phone}</span><br>
          <button class="reserve-btn" style="margin-top:8px;padding:6px 12px;border:none;border-radius:12px;background-color:#3498db;color:white;cursor:pointer;">
            예약
          </button>
        `;
  
        // 병원 항목 클릭 시 지도 이동 & 마커 표시
        itemEl.onclick = () => {
          map.setCenter(position);
          infowindow.setContent(`<div style="padding:5px;"><a href="${place.place_url}" target="_blank" style="text-decoration:none;color:#3498db;">${place.place_name}</a></div>`);
          infowindow.open(map, marker);
        };
  
        // 예약 버튼 클릭 시 reservation.html 이동
        const reserveBtn = itemEl.querySelector('.reserve-btn');
        reserveBtn.addEventListener('click', (e) => {
          e.stopPropagation();  // 부모 li 클릭 이벤트 방지
          window.location.href = '/reservation';
        });
  
        listEl.appendChild(itemEl);
      });
  
      map.setBounds(bounds);
      map.setLevel(map.getLevel() - 1);
    }
  
    function removeMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }
  
    function displayPagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      paginationEl.innerHTML = '';
      for (let i = 1; i <= pagination.last; i++) {
        const a = document.createElement('a');
        a.href = '#';
        a.innerText = i;
        if (i === pagination.current) a.className = 'on';
        else a.onclick = () => pagination.gotoPage(i);
        paginationEl.appendChild(a);
      }
    }
  
    // 현재 위치 기반 지도 초기화
    navigator.geolocation.getCurrentPosition(function (position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      initMap(lat, lng);
      document.getElementById('keyword').value = '병원';
      searchPlaces();
    }, function () {
      initMap(37.5665, 126.9780); // 서울 기본 위치
      searchPlaces();
    });
  </script>
  </body>
</html>