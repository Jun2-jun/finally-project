<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‹¥í„°í“¨ì²˜ - ì˜ˆì•½ ì™„ë£Œ</title>
  <link rel="icon" href="{{ url_for('static', filename='img/logo4.png') }}" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/submit_reservation.css') }}">
  <script src="{{ url_for('static', filename='js/reservation.js') }}"></script>
  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ API ì„œë²„ì— ì˜ˆì•½ ì •ë³´ ì „ì†¡
    document.addEventListener('DOMContentLoaded', function() {
      // ì˜ˆì•½ ì •ë³´ ê°ì²´ ìƒì„±
      const reservationData = {
        name: "{{ name }}",
        phone: "{{ phone }}",
        hospital: "{{ hospital }}",
        address: "{{ address }}",
        message: "{{ message }}",
        email: "{{ email }}",
        reservation_time: "{{ reservation_time }}"
      };

      // API ì—°ê²° ìƒíƒœ ì²´í¬
      testApiConnection()
        .then(isConnected => {
          if (!isConnected) {
            console.warn('API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ì²˜ë¦¬ë§Œ ì§„í–‰í•©ë‹ˆë‹¤.');
            return;
          }
          
          // ìƒíƒœ í‘œì‹œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
          const statusElement = document.createElement('div');
          statusElement.id = 'api-status';
          statusElement.classList.add('api-status');
          document.querySelector('.details').after(statusElement);
          
          statusElement.innerHTML = `
            <i data-lucide="loader"></i>
            <p>ì˜ˆì•½ ì •ë³´ë¥¼ ì„œë²„ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...</p>
          `;
          lucide.createIcons();

          // API ì„œë²„ë¡œ ì˜ˆì•½ ì •ë³´ ì „ì†¡
          sendReservationToAPI(reservationData)
            .then(response => {
              console.log('ì˜ˆì•½ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', response);
              
              // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
              statusElement.classList.add('success');
              statusElement.innerHTML = `
                <i data-lucide="check-circle"></i>
                <p>ì˜ˆì•½ ì •ë³´ê°€ DBì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <p>ì˜ˆì•½ ID: ${response.data.reservation_id}</p>
              `;
              lucide.createIcons();
            })
            .catch(error => {
              console.error('ì˜ˆì•½ DB ì €ì¥ ì‹¤íŒ¨:', error);
              
              // ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
              statusElement.classList.add('error');
              statusElement.innerHTML = `
                <i data-lucide="alert-triangle"></i>
                <p>ì˜ˆì•½ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <p>ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
              `;
              lucide.createIcons();
            });
        });
    });

    // ì´ë©”ì¼ ì „ì†¡ í¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleEmailSubmit(event) {
      event.preventDefault();
      
      // ì´ë©”ì¼ ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
      const emailButton = document.querySelector('button[type="submit"]');
      const originalText = emailButton.innerHTML;
      emailButton.disabled = true;
      emailButton.innerHTML = '<i data-lucide="loader"></i> ì „ì†¡ ì¤‘...';
      lucide.createIcons();

      // í¼ ë°ì´í„° ìˆ˜ì§‘
      const form = event.target;
      const emailData = {
        hospital: form.hospital.value,
        address: form.address.value,
        name: form.name.value,
        phone: form.phone.value,
        message: form.message.value,
        email: form.email.value,
        reservation_time: form.reservation_time.value
      };

      // API í˜¸ì¶œ
      sendConfirmationEmail(emailData)
        .then(response => {
          alert('ì˜ˆì•½ í™•ì¸ ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          emailButton.innerHTML = '<i data-lucide="check"></i> ì „ì†¡ ì™„ë£Œ';
          lucide.createIcons();
        })
        .catch(error => {
          alert(`ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
          emailButton.disabled = false;
          emailButton.innerHTML = originalText;
          lucide.createIcons();
        });
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ‰ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰</h1>
    
    <div class="details">
      <div class="detail-item"><strong>ë³‘ì› ì´ë¦„</strong><span>{{ hospital }}</span></div>
      <div class="detail-item"><strong>ë³‘ì› ì£¼ì†Œ</strong><span>{{ address }}</span></div>
      <div class="detail-item"><strong>ì˜ˆì•½ì ì´ë¦„</strong><span>{{ name }}</span></div>
      <div class="detail-item"><strong>ì—°ë½ì²˜</strong><span>{{ phone }}</span></div>
      <div class="detail-item"><strong>ì˜ˆì•½ ì‹œê°„</strong><span>{{ reservation_time }}</span></div>
      <div class="detail-item"><strong>ìš”ì²­ ì‚¬í•­</strong><span>{{ message or "ì—†ìŒ" }}</span></div>
      <div class="detail-item"><strong>ì´ë©”ì¼</strong><span>{{ email or "ì—†ìŒ" }}</span></div>
    </div>
    
    <div class="btn-group">
      <a href="/dashboard" class="btn"><i data-lucide="home"></i> í™ˆìœ¼ë¡œ</a>
      <a href="/find" class="btn"><i data-lucide="calendar-plus"></i> ë‹¤ì‹œ ì˜ˆì•½</a>
      <form method="POST" action="/send_email" onsubmit="handleEmailSubmit(event)">
        <input type="hidden" name="hospital" value="{{ hospital }}">
        <input type="hidden" name="address" value="{{ address }}">
        <input type="hidden" name="name" value="{{ name }}">
        <input type="hidden" name="phone" value="{{ phone }}">
        <input type="hidden" name="reservation_time" value="{{ reservation_time }}">
        <input type="hidden" name="message" value="{{ message }}">
        <input type="hidden" name="email" value="{{ email }}">
        <button type="submit" class="btn"><i data-lucide="mail"></i> ì´ë©”ì¼ ì „ì†¡</button>
      </form>
    </div>
  </div>
  <script>lucide.createIcons();</script>
</body>
</html>
